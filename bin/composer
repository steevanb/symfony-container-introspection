#!/usr/bin/env bash

set -eu

readonly ROOT_DIR="$(realpath "$(dirname "$(realpath "$0")")/..")"
source "${ROOT_DIR}"/config/docker.inc.bash

readonly DOCKER_IMAGE_NAME="${DOCKER_CI_IMAGE_NAME}"
source "${ROOT_DIR}/bin/dockerise.inc.bash"

phpVersion="7.4"
clearCache=false
composerParameters=
for arg in "${@}"; do
    if [ "${arg:0:6}" == "--php=" ]; then
        phpVersion="${arg:6}"
    elif [ "${arg}" == "--clear-cache" ]; then
        clearCache=true
    else
        composerParameters="${composerParameters} ${arg}"
    fi
done

if [ "${clearCache}" == true ]; then
    echo "Clear cache"
    rm -rf "${ROOT_DIR}/var/composer"
fi

php${phpVersion} /usr/local/bin/composer ${composerParameters}
